#!/usr/bin/env bash
set -euo pipefail

# ===================================================================
# Panda CMS — CI Runner (Option A: direct bind-mount)
# CI Docker image: ubuntu 24.04 + Ruby 3.4.7 (mise) + PG17 + Chrome
# ===================================================================

CI_IMAGE="ghcr.io/tastybamboo/panda-cms-test:latest"
CI_DOCKERFILE="docker/ci.Dockerfile"
PLATFORM="linux/amd64"

CONTAINER_NAME="panda-cms-ci"
BUNDLE_VOL="ci_bundle_cache"

# -------------------------------------------------------------------
# Helpers
# -------------------------------------------------------------------
header() { printf "\n\033[1;36m▶ %s\033[0m\n" "$1"; }
die()    { echo "ERROR: $1" >&2; exit 1; }

docker info >/dev/null 2>&1 || die "Docker is not running."

# -------------------------------------------------------------------
# Usage
# -------------------------------------------------------------------
if [[ "${1:-}" == "" ]]; then
  cat <<EOF
Usage: bin/ci [COMMAND]

Commands:
  build         Build the CI Docker image (local)
  push          Build and push to registry (for CI)
  test          Run test suite inside container
  shell         Open an interactive shell
  clean         Remove containers and volume

Options (build/push):
  --no-cache    Force docker build without cache

EOF
  exit 0
fi

NO_CACHE="${NO_CACHE:-0}"
COMMAND="$1"
shift || true

# -------------------------------------------------------------------
# Parse optional flags (for build/push)
# -------------------------------------------------------------------
while [[ "${1:-}" == --* ]]; do
  case "$1" in
    --no-cache) NO_CACHE=1 ;;
    --help|-h)  exec "$0" ;;
    *) die "Unknown option: $1" ;;
  esac
  shift
done

# -------------------------------------------------------------------
# Build Image — local (--load)
# -------------------------------------------------------------------
build_image() {
  header "Building CI Docker image (with --load)"

  local cache_args=()
  if [[ "$NO_CACHE" == "1" ]]; then
    cache_args+=(--no-cache)
    header "NO_CACHE=1 set — building without cache"
  fi

  docker buildx build \
    --platform "$PLATFORM" \
    --progress plain \
    --load \
    "${cache_args[@]}" \
    -t "$CI_IMAGE" \
    -f "$CI_DOCKERFILE" \
    .

  header "✓ Build complete"
}

# -------------------------------------------------------------------
# Build & Push — GitHub Actions / CI pipeline
# -------------------------------------------------------------------
push_image() {
  header "Building & pushing CI Docker image"

  local cache_args=()
  if [[ "${NO_CACHE:-}" == "1" ]]; then
    cache_args+=(--no-cache)
    header "NO_CACHE=1 set — building without cache"
  fi

  docker buildx build \
    --platform "$PLATFORM" \
    --progress plain \
    --push \
    "${cache_args[@]}" \
    -t "$CI_IMAGE" \
    -f "$CI_DOCKERFILE" \
    .

  header "✓ Pushed to $CI_IMAGE"
}

# -------------------------------------------------------------------
# Env banner printed *inside* the container
# -------------------------------------------------------------------
env_banner() {
  cat <<'EOF'
echo "-------------------------------------------------------"
echo " Panda CMS — CI Environment"
echo "-------------------------------------------------------"

echo -n " Ruby:           "; ruby -v
echo -n " Rails:          "; ruby -e 'puts Gem.loaded_specs["rails"]&.version'
echo -n " PostgreSQL:     "; psql --version 2>/dev/null | awk '{print $3}'
echo -n " Chrome:         "; google-chrome --version
echo -n " CPU Arch:       "; uname -m

echo "-------------------------------------------------------"
EOF
}

# -------------------------------------------------------------------
# Run tests (direct bind-mount / no re-bundling)
# -------------------------------------------------------------------
run_tests() {
  header "Running test suite inside CI container"

  docker run --rm \
    --platform "$PLATFORM" \
    --name "$CONTAINER_NAME" \
    -v "$(pwd)":/app \
    -v "ci_bundle_cache:/usr/local/bundle" \
    -e RAILS_ENV=test \
    -e CI=true \
    -e CUPRITE_TIMEOUT="${CUPRITE_TIMEOUT:-30}" \
    -e CUPRITE_PROCESS_TIMEOUT="${CUPRITE_PROCESS_TIMEOUT:-60}" \
    -e FERRUM_TIMEOUT="${FERRUM_TIMEOUT:-${CUPRITE_TIMEOUT:-30}}" \
    -e FERRUM_PROCESS_TIMEOUT="${FERRUM_PROCESS_TIMEOUT:-${CUPRITE_PROCESS_TIMEOUT:-60}}" \
    "$CI_IMAGE" \
    bash -lc "
      start-services
      export CUPRITE_TIMEOUT=${CUPRITE_TIMEOUT:-30}
      export CUPRITE_PROCESS_TIMEOUT=${CUPRITE_PROCESS_TIMEOUT:-60}
      export FERRUM_TIMEOUT=${FERRUM_TIMEOUT:-${CUPRITE_TIMEOUT:-30}}
      export FERRUM_PROCESS_TIMEOUT=${FERRUM_PROCESS_TIMEOUT:-${CUPRITE_PROCESS_TIMEOUT:-60}}
      $(env_banner)
      echo '▶ Installing gems...'
      bundle config set --local path 'vendor/bundle'
      bundle install --jobs=4 --retry=3
      echo '▶ Creating database with default schema...'
      bundle exec rails db:create db:schema:load
      echo '▶ Running Chrome smoke test...'
      bin/chrome-smoke-test || exit 1
      echo '▶ Running tests...'
      bundle exec rspec --format documentation --color
      stop-services
    "
}

# -------------------------------------------------------------------
# Shell
# -------------------------------------------------------------------
run_shell() {
  header "Opening interactive CI shell"

  docker run --rm -it \
    --platform "$PLATFORM" \
    --name "$CONTAINER_NAME" \
    -v "$(pwd)":/app:delegated \
    -v "$BUNDLE_VOL:/usr/local/bundle" \
    -e RAILS_ENV=test \
    "$CI_IMAGE" \
    bash
}

# -------------------------------------------------------------------
# Clean
# -------------------------------------------------------------------
clean_ci() {
  header "Cleaning CI environment"
  docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
  docker volume rm "$BUNDLE_VOL" >/dev/null 2>&1 || true
  echo "✓ Cleaned"
}

# -------------------------------------------------------------------
# Dispatcher
# -------------------------------------------------------------------
case "$COMMAND" in
  build) build_image ;;
  push)  push_image ;;
  test)  run_tests ;;
  shell) run_shell ;;
  clean) clean_ci ;;
  *) die "Unknown command: $COMMAND" ;;
esac
