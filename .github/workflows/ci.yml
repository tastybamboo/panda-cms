---
name: 'App Tests'

'on': # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
  merge_group:
    types: [checks_requested]

jobs:
  seclint:
    name: 'Security Checks & Linters'
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Cache gems'
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-lint-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-lint-
            ${{ runner.os }}-gems-

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Bundler Audit'
        run: 'bundle exec bundle-audit --update && bundle exec bundle-audit check'
      - name: 'Brakeman'
        run: 'bundle exec brakeman --quiet'
      - name: 'StandardRB Check'
        run: 'bundle exec standardrb'
      - name: 'ERB Check'
        run: 'bundle exec erb_lint app/views --lint-all'
      - name: 'YAML Lint'
        run: 'yamllint -c .yamllint .'

  js-verification:
    name: 'Readiness (Fail-Fast)'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
      options: --shm-size=2gb
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'
      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start Xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: 'Cache gems'
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-test-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-test-
            ${{ runner.os }}-gems-

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          rm -rf db/migrate
          mkdir -p db/migrate
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: 'Compile CSS assets'
        run: |
          bundle exec rake app:panda:core:assets:compile

      - name: 'Verify Chrome'
        run: |
          echo "Checking Chrome installation..."
          which google-chrome || which chromium || which chromium-browser || echo "Chrome not found"
          google-chrome --version || chromium --version || chromium-browser --version || echo "Cannot get Chrome version"

      - name: 'Check shared memory size'
        run: |
          echo "üíæ Checking /dev/shm size in container..."
          df -h /dev/shm
          echo ""
          echo "If /dev/shm shows 64M, Chrome will crash instantly."
          echo "We need at least 2GB for Chrome to work properly."

      - name: 'Test Chrome startup directly'
        run: |
          echo "üîß Testing Chrome startup with minimal flags..."
          echo "This will show Chrome's actual startup error if it crashes."
          echo ""
          echo "Actual /dev/shm size:"
          df -h /dev/shm
          echo ""
          CHROME_BIN=$(which google-chrome || which chromium || which chromium-browser)
          echo "Chrome binary: $CHROME_BIN"
          echo ""
          echo "Attempting to start Chrome..."
          timeout 5 $CHROME_BIN \
            --headless \
            --no-sandbox \
            --disable-gpu \
            --disable-dev-shm-usage \
            --disable-software-rasterizer \
            --remote-debugging-port=9222 \
            about:blank \
            2>&1 | tee chrome_startup.log || echo "Chrome exited with code $?"
          echo ""
          echo "Chrome startup log:"
          cat chrome_startup.log || echo "No log file generated"

      - name: 'Check importmap configuration'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üì¶ Checking importmap configuration..."
          echo "Running: rails importmap:json"
          bundle exec rails importmap:json || echo "Failed to generate importmap JSON"
          echo ""
          echo "Checking static importmap.json file..."
          cat public/assets/importmap.json || echo "public/assets/importmap.json not found"
          echo ""
          echo "Listing public/assets directory structure..."
          ls -R public/assets || echo "public/assets directory not found"
          echo ""
          echo "Checking if all importmap paths exist..."
          bundle exec rails runner 'Rails.application.importmap.each_entry { |name, path| puts "#{name}: #{path}" }' || echo "Cannot enumerate importmap entries"

      - name: 'Check asset readiness'
        run: |
          echo "üìã Checking compiled CSS assets..."
          echo "Looking for CSS files in spec/dummy/public/panda-core-assets/:"
          ls -la spec/dummy/public/panda-core-assets/ || echo "Directory not found"
          echo ""
          echo "First 20 lines of CSS file (if exists):"
          find spec/dummy/public/panda-core-assets/ -name "*.css" -type f | head -1 | xargs head -20 || echo "No CSS file found"

      - name: 'Run Chrome boot test'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
          RSPEC_DEBUG: 'true'
        run: |
          echo "üîç Running Chrome boot test (no page visit)..."
          echo "This tests if Chrome can start WITHOUT loading any page."
          echo "Isolates Chrome startup issues from server/importmap issues."
          script -q -e -c "bundle exec rspec spec/system/aaa_chrome_boot_spec.rb --format documentation --color --fail-fast" /dev/null

      - name: 'Test Rails server boot'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üöÇ Testing if Rails can boot..."
          bundle exec rails runner "puts '‚úÖ Rails server booted successfully'" || echo "‚ùå Rails failed to boot"

      - name: 'Run server verification'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
          RSPEC_DEBUG: 'true'
        run: |
          echo "üîç Running server verification test..."
          script -q -e -c "bundle exec rspec spec/system/aaa_server_verification_spec.rb --format documentation --color" /dev/null

      - name: 'Run JavaScript verification'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
          RSPEC_DEBUG: 'true'
          CUPRITE_PROCESS_TIMEOUT: '20'
        run: |
          echo "üîç Running JavaScript verification test (fail-fast with debug)..."
          echo "Chrome version:"
          google-chrome --version || chromium --version || echo "Cannot determine Chrome version"
          echo "Xvfb display: $DISPLAY"
          echo "Starting tests..."
          script -q -e -c "bundle exec rspec spec/system/javascript_verification_spec.rb --format documentation --color --fail-fast" /dev/null

      - name: 'Upload compiled CSS'
        uses: actions/upload-artifact@v5
        if: success()
        with:
          name: compiled-assets
          path: spec/dummy/public/panda-core-assets/
          retention-days: 1

  model-specs:
    name: 'Model Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Cache gems'
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-test-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-test-
            ${{ runner.os }}-gems-

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          rm -rf db/migrate
          mkdir -p db/migrate
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: 'Run model specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "üì¶ Running model specs..."
          script -q -e -c "bundle exec rspec spec/models --format documentation --color" /dev/null

  request-specs:
    name: 'Request Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Cache gems'
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-test-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-test-
            ${{ runner.os }}-gems-

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          rm -rf db/migrate
          mkdir -p db/migrate
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: 'Run request specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "üåê Running request specs..."
          script -q -e -c "bundle exec rspec spec/requests --format documentation --color" /dev/null

  lib-specs:
    name: 'Lib/Services Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Cache gems'
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-test-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-test-
            ${{ runner.os }}-gems-

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          rm -rf db/migrate
          mkdir -p db/migrate
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: 'Run lib/services specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "‚öôÔ∏è  Running lib/services specs..."
          script -q -e -c "bundle exec rspec spec/lib spec/services --format documentation --color" /dev/null || true

  system-specs:
    name: 'System Specs (Browser Tests)'
    needs: [seclint, js-verification]
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
      options: --shm-size=2gb
    permissions:
      contents: read
      pull-requests: write
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'
      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start Xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: 'Cache gems'
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-test-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-test-
            ${{ runner.os }}-gems-

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          rm -rf db/migrate
          mkdir -p db/migrate
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: 'Download compiled assets'
        uses: actions/download-artifact@v5
        with:
          name: compiled-assets

      - name: 'Verify Chrome'
        run: |
          echo "Checking Chrome installation..."
          which google-chrome || which chromium || which chromium-browser || echo "Chrome not found"
          google-chrome --version || chromium --version || chromium-browser --version || echo "Cannot get Chrome version"

      - name: 'Run system specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "üñ•Ô∏è  Running system specs (excluding JS verification)..."
          script -q -e -c "bundle exec rspec spec/system --tag ~skip --exclude-pattern 'spec/system/javascript_verification_spec.rb' --format documentation --color" /dev/null

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-system
          path: coverage/

      - name: 'Upload screenshots on failure'
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: screenshots
          path: ${{ github.workspace }}/spec/tmp/capybara
          if-no-files-found: ignore
