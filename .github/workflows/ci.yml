---
name: 'App Tests'

'on': # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
  merge_group:
    types: [checks_requested]

jobs:
  seclint:
    name: 'Security Checks & Linters'
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
    steps:
      - uses: 'actions/checkout@v5'

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Bundler Audit'
        run: '#bundle exec bundle-audit --update && bundle exec bundle-audit check'
      - name: 'Brakeman'
        run: '#bundle exec brakeman --quiet'
      - name: 'StandardRB Check'
        run: '#bundle exec standardrb'
      - name: 'ERB Check'
        run: '#bundle exec erb_lint app/views --lint-all'
      - name: 'YAML Lint'
        run: '#yamllint -c .yamllint .'

  model-specs:
    name: 'Model Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üìã Loading schema (baseline with all tables)..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      - name: 'Run model specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "üì¶ Running model specs..."
          #bundle exec rspec spec/models --format documentation --color

  request-specs:
    name: 'Request Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üìã Loading schema (baseline with all tables)..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      - name: 'Run request specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "üåê Running request specs..."
          #bundle exec rspec spec/requests --format documentation --color

  lib-specs:
    name: 'Lib Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: 'actions/checkout@v5'

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üìã Loading schema (baseline with all tables)..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      - name: 'Run lib/services specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          echo "‚öôÔ∏è  Running lib specs..."
          #bundle exec rspec spec/lib --format documentation --color

  system-specs:
    name: 'System Specs (Browser Tests)'
    needs: [seclint]
    runs-on: 'ubuntu-latest'
    permissions:
      contents: read
      checks: write
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
      options: --shm-size=2gb
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5

      - name: Start Xvfb
        run: Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: Bundle install
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üìã Loading schema (baseline with all tables)..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      - name: Panda asset generation and verification
        uses: tastybamboo/panda-assets-verify-action@v1
        with:
          dummy_root: spec/dummy

      - name: Verify Chromium can start
        run: |
          echo "üîç Testing if Chromium can start..."
          chromium --version || echo "‚ö†Ô∏è  Chromium version check failed"
          chromium --headless --no-sandbox --disable-gpu --print-to-pdf=/tmp/test.pdf about:blank 2>&1 || echo "‚ö†Ô∏è  Chromium test failed"
          if [ -f /tmp/test.pdf ]; then
            echo "‚úÖ Chromium successfully created PDF"
            ls -lh /tmp/test.pdf
          else
            echo "‚ùå Chromium failed to create PDF"
          fi

      - name: Check Xvfb status
        run: |
          echo "üîç Checking Xvfb status..."
          ps aux | grep -i xvfb || echo "‚ö†Ô∏è  Xvfb process not found"
          echo "DISPLAY environment variable: $DISPLAY"

      - name: Run smoke test
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          CUPRITE_PROCESS_TIMEOUT: 30
          CUPRITE_TIMEOUT: 15
          FERRUM_BROWSER_LOG: 'true'
        run: |
          echo "üß™ Running smoke test to verify browser startup..."
          bundle exec rspec spec/system/smoke_test_spec.rb --format documentation --color
        timeout-minutes: 5

      - name: Run system specs
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          CUPRITE_PROCESS_TIMEOUT: 30
          CUPRITE_TIMEOUT: 15
          FERRUM_BROWSER_LOG: 'true'
        run: |
          set -euo pipefail
          echo "üß™ Running full system test suite..."
          bundle exec rspec spec/system --format documentation --color
        timeout-minutes: 30

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-system
          path: coverage/

      - name: 'Upload screenshots on failure'
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: screenshots
          path: ${{ github.workspace }}/spec/tmp/capybara
          if-no-files-found: ignore
