name: Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: RSpec (panda-cms-test container)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    container:
      image: ghcr.io/tastybamboo/panda-cms-test:latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd="pg_isready -U postgres || exit 0"
          --health-interval=5s
          --health-retries=60
          --network-alias=postgres

    env:
      RAILS_ENV: test
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: test
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/test
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_NAME: test
      CI: true
      BUNDLE_GEMFILE: /app/Gemfile
      CUPRITE_TIMEOUT: 30
      CUPRITE_PROCESS_TIMEOUT: 120
      FERRUM_PROCESS_TIMEOUT: 120
      CUPRITE_DEBUG: 'true'
      FERRUM_LOG: STDOUT
      BROWSER_PATH: /usr/bin/chromium
      RAILS_LOG_TO_STDOUT: 'true'
      CAPYBARA_SERVER_VERBOSE: 'true'
      RSPEC_ARGS: ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show environment
        run: |
          ruby -v
          bundle -v
          which ruby
          which bundle
          echo $PATH

      - name: Prepare database
        run: |
          bundle exec rails db:schema:load

      - name: Panda asset generation and verification
        uses: tastybamboo/panda-assets-verify-action@v1
        if: ${{ env.ACT != 'true' }}
        continue-on-error: ${{ env.ACT == 'true' }}
        with:
          dummy_root: spec/dummy

      - name: Run RSpec
        run: |
          bundle exec rspec spec/system/panda/cms/admin/pages/list_pages_spec.rb ${RSPEC_ARGS:---format documentation}
