<div class="nested-form-wrapper rounded-2xl border border-gray-200 bg-white mb-4"
     data-controller="collapsible-item"
     data-collapsible-item-expanded-value="<%= form.object.new_record? %>"
     data-new-record="<%= form.object.new_record? %>">
  <%# Header (always visible, clickable) %>
  <div class="flex items-center justify-between px-4 py-3 cursor-pointer"
       data-action="click->collapsible-item#toggle">
    <div class="flex items-center gap-2">
      <span class="text-sm font-medium text-gray-700"
            data-collapsible-item-target="summary"
            data-placeholder="New field">
        <%= form.object.label.presence || "New field" %>
      </span>
      <% if form.object.field_type.present? %>
        <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">
          <%= form.object.field_type.titleize %>
        </span>
      <% end %>
    </div>
    <div class="flex items-center gap-3">
      <button type="button"
              class="text-xs text-red-500 hover:text-red-700"
              data-action="click->nested-form#remove click:stop->collapsible-item#noop">
        <i class="fa-solid fa-trash mr-1"></i> Remove
      </button>
      <i class="fa-solid fa-chevron-down text-xs text-gray-400 transition-transform duration-200"
         data-collapsible-item-target="icon"></i>
    </div>
  </div>

  <%# Body (collapsible) %>
  <div class="overflow-hidden transition-all duration-200 ease-out"
       data-collapsible-item-target="body">
    <div class="px-4 pb-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <%= form.select :field_type, Panda::CMS::FormField::FIELD_TYPES.map { |t| [t.titleize, t] }, { label: "Field Type" }, { data: { action: "change->form-fields#fieldTypeChanged", form_fields_target: "fieldType" } } %>
        <%= form.text_field :label, placeholder: "e.g., Your Name", data: { action: "input->form-fields#generateName input->collapsible-item#updateSummary", form_fields_target: "label" } %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <%= form.text_field :name, placeholder: "your_name", meta: "Unique identifier (auto-generated)", data: { form_fields_target: "name" } %>
        <%= form.text_field :placeholder, placeholder: "Enter your name..." %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <%= form.text_field :hint, label: "Help Text", placeholder: "Additional instructions for the user" %>
        <%= form.text_field :position, type: "number", value: form.object.position || 0 %>
      </div>

      <div class="mt-4 flex items-center gap-6">
        <%= form.check_box :required %>
        <%= form.check_box :active %>
      </div>

      <div class="mt-4 <%= form.object.has_options? ? '' : 'hidden' %>" data-form-fields-target="optionsSection">
        <%= form.text_area :options, rows: 3, label: "Options", placeholder: "One option per line, or value|label format", meta: "For select, checkbox, and radio fields" %>
      </div>
    </div>
  </div>

  <%= form.hidden_field :_destroy %>
</div>
