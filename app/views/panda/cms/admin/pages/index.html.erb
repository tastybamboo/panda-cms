<%= render Panda::Core::Admin::ContainerComponent.new do |component| %>
  <% component.with_heading_slot(text: "Pages", level: 1) do |heading| %>
    <% heading.with_button(action: :add, text: "Add Page", href: new_admin_cms_page_path) %>
  <% end %>

  <% if root_page %>
    <% page_rows = show_archived ? root_page.self_and_descendants : root_page.self_and_descendants.not_archived %>
    <div data-controller="tree" data-tree-target="container" style="opacity: 0; transition: opacity 0.2s;">
      <%= render Panda::Core::Admin::TableComponent.new(term: "page", rows: page_rows) do |table| %>
        <% table.column("Name") do |page| %>
          <div class="flex flex-col <%= "opacity-50" if page.archived? %>" data-tree-target="row" data-page-id="<%= page.id %>" data-level="<%= page.level %>" data-parent-id="<%= page.parent_id %>">
            <%# Add indentation for nested levels %>
            <% indent_class = case page.level
               when 0 then ""
               when 1 then "pl-6"
               when 2 then "pl-12"
               when 3 then "pl-16"
               when 4 then "pl-20"
               when 5 then "pl-24"
               else "pl-28"
               end %>
            <div class="flex items-center gap-2 <%= indent_class %>">
              <%# Chevron/icon section - all use w-4 for consistent spacing %>
              <div class="w-4 flex items-center justify-center">
                <% if page.children_count > 0 %>
                  <% if page.level > 0 %>
                    <%# Non-root pages with children: show chevron button %>
                    <button type="button"
                            class="text-xs text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary rounded cursor-pointer"
                            data-tree-target="toggle"
                            data-action="click->tree#toggle"
                            data-page-id="<%= page.id %>">
                      <i class="fa-solid fa-chevron-right"></i>
                    </button>
                  <% else %>
                    <%# Root page (Home): show folder icon %>
                    <i class="fa-solid fa-folder text-gray-500"></i>
                  <% end %>
                <% else %>
                  <%# Leaf pages: show file icon %>
                  <i class="fa-solid fa-file text-gray-400"></i>
                <% end %>
              </div>
              <div class="flex flex-col">
                <div class="flex items-center gap-2">
                  <%= link_to page.title, edit_admin_cms_page_path(page), class: "font-medium hover:text-primary" %>
                  <% if page.archived? %>
                    <span class="inline-flex items-center rounded-md bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">Archived</span>
                  <% end %>
                </div>
                <div class="text-xs text-black/60 mt-0.5">
                  <%= page.path %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        <% table.column("Type", width: "12%") { |page| render Panda::Core::Admin::TagComponent.new(page_type: page.page_type.to_sym) } %>
        <% table.column("Last Updated", width: "18%") { |page| render Panda::Core::Admin::UserActivityComponent.new(at: page.last_updated_at) } %>
      <% end %>
    </div>

    <% if archived_count > 0 %>
      <div class="px-6 pb-4">
        <% if show_archived %>
          <%= link_to "Hide archived pages", admin_cms_pages_path, class: "text-sm text-gray-500 hover:text-gray-700" %>
        <% else %>
          <%= link_to "Show #{archived_count} archived #{"page".pluralize(archived_count)}", admin_cms_pages_path(show_archived: "true"), class: "text-sm text-gray-500 hover:text-gray-700" %>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="p-6">
      <%= render Panda::Core::Admin::CalloutComponent.new(
        kind: :error,
        text: "No homepage (at /) found. Please create a homepage to start building your site."
      ) %>
    </div>
  <% end %>
<% end %>
