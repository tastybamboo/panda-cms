<% period = @period || 30.days %>
<div class="">
  <%= render Panda::Core::Admin::ContainerComponent.new do |container| %>
    <% container.with_heading_slot(text: "Dashboard", level: 1) do |heading| %>
      <% heading.with_button(action: :add, text: "Add Page", href: new_admin_cms_page_path) %>
    <% end %>
    <% ga_available = Panda::CMS::Analytics.available? rescue false %>
    <% has_local_visits = !ga_available && Panda::CMS::Visit.exists? %>

    <% if ga_available %>
      <!-- Analytics widgets when GA is configured -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-8">
        <%= render Panda::CMS::Admin::AnalyticsWidgetComponent.new(period: period) %>
        <%= render Panda::CMS::Admin::TopReferrersWidgetComponent.new(period: period) %>
      </div>

      <div class="grid grid-cols-1 gap-5 mt-5">
        <%= render Panda::CMS::Admin::PageViewsChartComponent.new(period: period, interval: :daily) %>
      </div>

      <div class="grid grid-cols-1 gap-5 mt-5">
        <%= render Panda::CMS::Admin::RecentPagesWidgetComponent.new(limit: 10) %>
      </div>
    <% else %>
      <!-- Local analytics widgets -->
      <% if has_local_visits %>
        <dl class="grid grid-cols-1 gap-5 mt-5 sm:grid-cols-3">
          <%= render Panda::Core::Admin::StatisticsComponent.new(metric: "Views Today", value: Panda::CMS::Visit.group_by_day(:visited_at, last: 1).count.values.first || 0) %>
          <%= render Panda::Core::Admin::StatisticsComponent.new(metric: "Views Last Week", value: Panda::CMS::Visit.group_by_week(:visited_at, last: 1).count.values.first || 0) %>
          <%= render Panda::Core::Admin::StatisticsComponent.new(metric: "Views Last Month", value: Panda::CMS::Visit.group_by_month(:visited_at, last: 1).count.values.first || 0) %>
        </dl>
      <% end %>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-8">
        <%= render Panda::CMS::Admin::AnalyticsWidgetComponent.new(period: period) %>
        <% if has_local_visits %>
          <%= render Panda::CMS::Admin::PopularPagesComponent.new(
            popular_pages: Panda::CMS::Visit.popular_pages(limit: 10),
            period_name: "All Time"
          ) %>
        <% end %>
      </div>

      <div class="grid grid-cols-1 gap-5 mt-5">
        <%= render Panda::CMS::Admin::RecentPagesWidgetComponent.new(limit: 10) %>
      </div>
    <% end %>
  <% end %>
</div>
